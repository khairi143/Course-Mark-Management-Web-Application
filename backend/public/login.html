<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
</head>
<body>
    <h1>Login</h1>

    <div id="message" style="color: red; margin-bottom: 10px;"></div>

    <form id="loginForm">
        <label for="username">Username:</label><br>
        <input type="text" id="username" name="username" required><br><br>

        <label for="password">Password:</label><br>
        <input type="password" id="password" name="password" required><br><br>

        <button type="submit">Login</button>
    </form>

    <script>
    const loginForm = document.getElementById('loginForm');
    const messageDiv = document.getElementById('message');

    function displayMessage(msg, isError = false) {
        messageDiv.textContent = msg;
        messageDiv.style.color = isError ? 'red' : 'green';
    }

    const roleMap = {
        1: 'lecturer',
        2: 'student',
        3: 'advisor',
        4: 'admin'
    };

    loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        const credentials = {
            username: username,
            password: password
        };

        const API_ENDPOINT = 'http://localhost:8080/api/login';

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(credentials)
            });

            if (response.ok) {
                const result = await response.json();
                const token = result.token;
                const user = result.user;

                // Map role_id to readable role name
                const roleName = roleMap[user.role_id] || 'unknown';

                // Save token and user data
                localStorage.setItem('jwt_token', token);
                localStorage.setItem('user_info', JSON.stringify({ ...user, role_name: roleName }));

                displayMessage(`Login successful! Welcome, ${user.username}. Role: ${roleName}`, false);
                console.log('Login Success:', result);

                // Redirect based on role
                setTimeout(() => {
                    if (roleName === 'student') {
                        window.location.href = '/student_dashboard.html';
                    } else if (roleName === 'lecturer') {
                        window.location.href = 'lecturer_dashboard.html';
                    } else if (roleName === 'advisor') {
                        window.location.href = 'advisor_dashboard.html';
                    } else if (roleName === 'admin') {
                        window.location.href = 'admin_dashboard.html';
                    } else {
                        window.location.href = 'dashboard.html';
                    }
                },  80000);

            } else {
                const errorResult = await response.json();
                displayMessage(`Login failed: ${errorResult.error || 'Unknown error'}`, true);
                console.error('Login Error:', errorResult);
            }
        } catch (error) {
            displayMessage('Network error. Could not connect to the server. Check console for details.', true);
            console.error('Fetch Error:', error);
        }
    });
</script>
</body>
</html>
